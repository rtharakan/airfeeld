openapi: 3.1.0
info:
  title: Airfeeld Aviation Games API
  description: Privacy-preserving aviation guessing game API
  version: 1.0.0
  contact:
    name: Airfeeld Project
  license:
    name: MIT

servers:
  - url: http://localhost:8000
    description: Development server
  - url: https://api.airfeeld.org
    description: Production server

tags:
  - name: Gameplay
    description: Core game mechanics (start, guess, complete)
  - name: Content
    description: Photo upload and management
  - name: Data
    description: Airports, airlines, aircraft databases
  - name: Leaderboard
    description: Rankings and scores
  - name: Players
    description: Account registration and management
  - name: Moderation
    description: Content moderation and flagging
  - name: System
    description: Health check, version info

paths:
  /health:
    get:
      tags: [System]
      summary: Health check
      description: Returns API health status
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy]
                  version:
                    type: string
                  timestamp:
                    type: string
                    format: date-time

  # ─────────────────────────────────────────────────────────────
  # Player Registration & Account Management
  # ─────────────────────────────────────────────────────────────
  
  /players/challenge:
    post:
      tags: [Players]
      summary: Request proof-of-work challenge
      description: |
        Issues a cryptographic challenge that must be solved before account creation.
        This prevents automated account creation and abuse.
        Rate limited: 3 challenges per IP per 15 minutes.
      responses:
        '200':
          description: Challenge issued
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
              description: Maximum requests per window
            X-RateLimit-Remaining:
              schema:
                type: integer
              description: Remaining requests in current window
            X-RateLimit-Reset:
              schema:
                type: integer
              description: Unix timestamp when window resets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProofOfWorkChallenge'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

  /players/register:
    post:
      tags: [Players]
      summary: Create new player account
      description: |
        Creates a new player account with username.
        Requires valid proof-of-work solution from /players/challenge.
        Rate limited: 3 accounts per IP per 24 hours.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlayerRegistration'
      responses:
        '201':
          description: Account created successfully
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
            X-RateLimit-Remaining:
              schema:
                type: integer
            X-RateLimit-Reset:
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlayerCreated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Username already taken
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: 'conflict'
                message: 'Username already taken'
        '422':
          description: Invalid proof-of-work solution
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: 'invalid_pow'
                message: 'Proof-of-work solution is invalid or expired'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

  /players/{player_id}/export:
    get:
      tags: [Players]
      summary: Export player data (GDPR compliance)
      description: |
        Returns all data associated with a player account in JSON format.
        Required for GDPR Article 20 (data portability).
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Player data export
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlayerDataExport'
        '404':
          $ref: '#/components/responses/NotFound'

  /players/{player_id}:
    delete:
      tags: [Players]
      summary: Delete player account (GDPR compliance)
      description: |
        Permanently deletes player account and all associated data.
        Required for GDPR Article 17 (right to erasure).
        This action cannot be undone.
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Account deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'

  # ─────────────────────────────────────────────────────────────
  # Photo Flagging & Moderation
  # ─────────────────────────────────────────────────────────────

  /photos/{photo_id}/flag:
    post:
      tags: [Moderation]
      summary: Flag a photo for review
      description: |
        Report a photo for content issues. Anonymous reports allowed.
        3+ flags trigger automatic priority boost in moderation queue.
      parameters:
        - name: photo_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PhotoFlagRequest'
      responses:
        '201':
          description: Flag submitted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  flag_id:
                    type: string
                    format: uuid
                  message:
                    type: string
                    example: 'Thank you for your report. Our team will review it.'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Already flagged by this reporter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ─────────────────────────────────────────────────────────────
  # Gameplay Endpoints
  # ─────────────────────────────────────────────────────────────

  /game/start:
    post:
      tags: [Gameplay]
      summary: Start new game round
      description: Creates new game round with random photo
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                player_id:
                  type: string
                  format: uuid
                  description: Player UUID (required for scoring)
      responses:
        '200':
          description: Game round started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameRoundStart'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: No photos available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /game/guess:
    post:
      tags: [Gameplay]
      summary: Submit guess for current round
      description: Submit airport guess and receive feedback
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GuessRequest'
      responses:
        '200':
          description: Guess processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Round not found or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /photos/upload:
    post:
      tags: [Content]
      summary: Upload new aviation photo
      description: Upload photo with EXIF stripping and airport association
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - airport_id
              properties:
                file:
                  type: string
                  format: binary
                  description: Image file (JPEG, PNG, WebP)
                airport_id:
                  type: string
                  description: ICAO code of airport
                player_id:
                  type: string
                  format: uuid
                  description: Uploader ID (optional, for tracking)
      responses:
        '201':
          description: Photo uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PhotoUploadResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '413':
          description: File too large (max 10MB)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /airports:
    get:
      tags: [Data]
      summary: Search airports
      description: Search airports by name or code
      parameters:
        - name: query
          in: query
          required: false
          schema:
            type: string
          description: Search query (name, IATA, or ICAO)
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of matching airports
          content:
            application/json:
              schema:
                type: object
                properties:
                  airports:
                    type: array
                    items:
                      $ref: '#/components/schemas/Airport'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer

  /airports/{icao}:
    get:
      tags: [Data]
      summary: Get airport by ICAO code
      parameters:
        - name: icao
          in: path
          required: true
          schema:
            type: string
            pattern: '^[A-Z]{4}$'
      responses:
        '200':
          description: Airport details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Airport'
        '404':
          $ref: '#/components/responses/NotFound'

  /leaderboard:
    get:
      tags: [Leaderboard]
      summary: Get leaderboard
      description: Returns top players by score
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            maximum: 100
        - name: period
          in: query
          schema:
            type: string
            enum: [all_time, monthly, weekly]
            default: all_time
      responses:
        '200':
          description: Leaderboard rankings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeaderboardResponse'

  /player/{player_id}:
    get:
      tags: [Leaderboard]
      summary: Get player stats
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Player statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlayerStats'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  schemas:
    # ─────────────────────────────────────────────────────────────
    # Security & Registration Schemas
    # ─────────────────────────────────────────────────────────────

    ProofOfWorkChallenge:
      type: object
      required:
        - challenge_id
        - challenge_nonce
        - difficulty
        - algorithm
        - expires_at
      properties:
        challenge_id:
          type: string
          format: uuid
          description: Reference ID for the challenge
        challenge_nonce:
          type: string
          minLength: 32
          maxLength: 32
          description: Server-generated random nonce
        difficulty:
          type: integer
          minimum: 4
          maximum: 6
          default: 4
          description: Required leading zeros in SHA-256 hash
        algorithm:
          type: string
          enum: [sha256]
          description: Hashing algorithm to use
        expires_at:
          type: string
          format: date-time
          description: Challenge expires after 5 minutes
        instructions:
          type: string
          example: 'Find nonce where SHA256(challenge_nonce + your_nonce) starts with 0000'

    PlayerRegistration:
      type: object
      required:
        - username
        - challenge_id
        - solution_nonce
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 20
          pattern: '^[a-zA-Z0-9_]+$'
          description: Alphanumeric + underscore only, no profanity
        challenge_id:
          type: string
          format: uuid
          description: ID from /players/challenge response
        solution_nonce:
          type: string
          description: Client-computed nonce that solves the challenge

    PlayerCreated:
      type: object
      required:
        - player_id
        - username
        - created_at
      properties:
        player_id:
          type: string
          format: uuid
        username:
          type: string
        created_at:
          type: string
          format: date-time
        message:
          type: string
          example: 'Account created successfully. Welcome to Airfeeld!'

    PlayerDataExport:
      type: object
      required:
        - player_id
        - username
        - exported_at
        - data
      properties:
        player_id:
          type: string
          format: uuid
        username:
          type: string
        exported_at:
          type: string
          format: date-time
        data:
          type: object
          properties:
            profile:
              type: object
              properties:
                total_score:
                  type: number
                games_played:
                  type: integer
                created_at:
                  type: string
                  format: date-time
            game_history:
              type: array
              items:
                type: object
                properties:
                  round_id:
                    type: string
                    format: uuid
                  score:
                    type: integer
                  completed_at:
                    type: string
                    format: date-time
            uploaded_photos:
              type: array
              items:
                type: object
                properties:
                  photo_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                  uploaded_at:
                    type: string
                    format: date-time

    PhotoFlagRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          enum: [inappropriate, wrong_airport, copyright, non_aviation, other]
          description: Category of the issue
        description:
          type: string
          maxLength: 500
          description: Optional details (no PII)
        reporter_id:
          type: string
          format: uuid
          nullable: true
          description: Player ID (optional, anonymous reports allowed)

    # ─────────────────────────────────────────────────────────────
    # Gameplay Schemas
    # ─────────────────────────────────────────────────────────────

    GameRoundStart:
      type: object
      required:
        - round_id
        - round_token
        - photo
        - expires_at
      properties:
        round_id:
          type: string
          format: uuid
        round_token:
          type: string
          description: Anti-cheat token for guess submission
        photo:
          $ref: '#/components/schemas/PhotoDisplay'
        expires_at:
          type: string
          format: date-time
          description: Round expires after 30 minutes

    PhotoDisplay:
      type: object
      required:
        - id
        - url
        - alt_text
        - width
        - height
      properties:
        id:
          type: string
          format: uuid
        url:
          type: string
          format: uri
          description: Photo URL (EXIF stripped)
        alt_text:
          type: string
          description: Accessibility description (doesn't reveal answer)
        width:
          type: integer
        height:
          type: integer

    GuessRequest:
      type: object
      required:
        - round_id
        - round_token
        - guessed_airport
      properties:
        round_id:
          type: string
          format: uuid
        round_token:
          type: string
        guessed_airport:
          type: string
          description: ICAO code of guessed airport

    GuessResponse:
      type: object
      required:
        - correct
        - attempt
        - final
      properties:
        correct:
          type: boolean
        attempt:
          type: integer
          minimum: 1
          maximum: 3
          description: Current attempt number
        final:
          type: boolean
          description: True if round complete
        score:
          type: integer
          enum: [0, 3, 5, 10]
          description: Points awarded (only if final=true)
        distance_km:
          type: number
          description: Distance from guess to correct (attempt 2 only)
        distance_mi:
          type: number
          description: Distance in miles (attempt 2 only)
        country_hint:
          type: string
          description: Country name (attempt 3 only)
        revealed_airport:
          $ref: '#/components/schemas/Airport'
          description: Correct answer (only if final=true and incorrect)
        difficulty_multiplier:
          type: number
          minimum: 1.0
          maximum: 3.0
          description: Photo difficulty (only if final=true)
        adjusted_score:
          type: number
          description: score * difficulty_multiplier (only if final=true)
        attribution:
          $ref: '#/components/schemas/Attribution'
          description: Photo credit (only if final=true)

    Airport:
      type: object
      required:
        - icao
        - name
        - country
        - latitude
        - longitude
      properties:
        icao:
          type: string
          pattern: '^[A-Z]{4}$'
        iata:
          type: string
          pattern: '^[A-Z]{3}$'
          nullable: true
        name:
          type: string
        country_code:
          type: string
          pattern: '^[A-Z]{2}$'
        country_name:
          type: string
        region:
          type: string
        municipality:
          type: string
        latitude:
          type: number
          minimum: -90
          maximum: 90
        longitude:
          type: number
          minimum: -180
          maximum: 180

    Attribution:
      type: object
      required:
        - source
        - license
      properties:
        source:
          type: string
          enum: [flickr, wikimedia, public_domain, user_upload]
        photographer_name:
          type: string
          nullable: true
        photographer_url:
          type: string
          format: uri
          nullable: true
        license:
          type: string
          enum: ['CC BY 2.0', 'CC BY-SA 2.0', 'CC0', 'Public Domain']
        original_url:
          type: string
          format: uri
          nullable: true

    PhotoUploadResponse:
      type: object
      required:
        - photo_id
        - status
      properties:
        photo_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending_review, approved]
        message:
          type: string
          example: 'Photo uploaded successfully and pending review'

    LeaderboardResponse:
      type: object
      required:
        - entries
        - period
        - last_updated
      properties:
        entries:
          type: array
          items:
            $ref: '#/components/schemas/LeaderboardEntry'
        period:
          type: string
          enum: [all_time, monthly, weekly]
        last_updated:
          type: string
          format: date-time

    LeaderboardEntry:
      type: object
      required:
        - rank
        - username
        - total_score
        - games_played
      properties:
        rank:
          type: integer
          minimum: 1
        player_id:
          type: string
          format: uuid
        username:
          type: string
        total_score:
          type: number
        games_played:
          type: integer

    PlayerStats:
      type: object
      required:
        - player_id
        - username
        - total_score
        - games_played
      properties:
        player_id:
          type: string
          format: uuid
        username:
          type: string
        total_score:
          type: number
        games_played:
          type: integer
        rank:
          type: integer
          nullable: true
        average_score:
          type: number
        best_round_score:
          type: integer

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            invalid_airport:
              value:
                error: 'validation_error'
                message: 'Invalid airport code'
            expired_round:
              value:
                error: 'round_expired'
                message: 'Game round has expired'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 'not_found'
            message: 'Resource not found'

    RateLimitExceeded:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: Maximum requests per window
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Remaining requests (0)
        X-RateLimit-Reset:
          schema:
            type: integer
          description: Unix timestamp when window resets
        Retry-After:
          schema:
            type: integer
          description: Seconds until rate limit resets
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 'rate_limit_exceeded'
            message: 'Too many requests. Please try again later.'
            details:
              retry_after_seconds: 3600

  securitySchemes:
    # Future: Add API key for rate limiting
    # For now: No authentication (anonymous play)
    {}

security: []
